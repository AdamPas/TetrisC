/**
 * @file block.c
 * @brief Functions to create and manipulate a block.
 *
 * @author Luca Della Libera (<luca310795@gmail.com>)
 * @version 1.0
 * @since 1.0
 *
 * @copyright Copyright Â© 2017 Luca Della Libera. All rights reserved.
 */

/**
 * @addtogroup Game
 * @{
 */
#include <stdlib.h>
#include <stdbool.h>

#include "shared.h"
#include "block.h"
#include "field.h"


#define COORD BLOCKS_DATA[b->type][b->rot][0] /**< @brief Label to index the 'coordinates' section of the data structure. */
#define ROT_CHECK BLOCKS_DATA[b->type][b->rot][1] /**< @brief Label to index the 'rotation-check' section of the data structure. */
#define DIR_CHECK BLOCKS_DATA[b->type][b->rot][2 + dir] /**< @brief Label to index the 'direction-check' section of the data structure. /*

/**
 * @brief Information to define the block types.
 * The first element of each sub-array is the size of the array itself.
 */
static const int BLOCKS_DATA[16][4][5][33] =
{
 {}, // BG
 { // F
  {{11, 0, 0,-1, 0,-1, 1, 1, 0, 0,-1}, {9, 0, 1, 1, 1, 1,-1,-1,-1}, {7,-1,-1, 0,-2, 1,-1}, {7,-1, 2, 0, 1, 1, 1}, {7, 0, 1, 2, 0, 1,-1}},
  {{11, 0, 0,-1, 0, 0, 1, 1, 1, 0,-1}, {9,-1, 1, 1, 0, 1,-1,-1,-1}, {7, 1, 0, 0,-2,-1,-1}, {7,-1, 1, 0, 2, 1, 2}, {7, 2, 1, 1, 0, 1,-1}},
  {{11, 0, 0,-1, 0, 0, 1, 1, 0, 1,-1}, {9,-1, 1, 1, 1, 0,-1,-1,-1}, {7, 1,-2, 0,-1,-1,-1}, {7,-1, 1, 0, 2, 1, 1}, {7, 1, 1, 2, 0, 2,-1}},
  {{11, 0, 0, 0, 1, 1, 0, 0,-1,-1,-1}, {9,-1, 0,-1, 1, 1, 1, 1,-1}, {7, 1,-1, 0,-2,-1,-2}, {7,-1, 0, 0, 2, 1, 1}, {7, 1, 1, 2, 0, 1,-1}}
 },
 { // F_R
  {{11, 0, 0,-1, 0,-1,-1, 1, 0, 0, 1}, {9, 0,-1, 1, 1, 1,-1,-1, 1}, {7,-1,-2, 0,-1, 1,-1}, {7,-1, 1, 0, 2, 1, 1}, {7,0,-1, 2, 0, 1, 1}},
  {{11, 0, 0, 1, 0, 0, 1,-1, 1, 0,-1}, {9, 1, 1,-1, 0, 1,-1,-1,-1}, {7,-1, 0, 0,-2, 1,-1}, {7,-1, 2, 0, 2, 1, 1}, {7,1,-1, 2, 0, 1, 1}},
  {{11, 0, 0,-1, 0, 0,-1, 1, 0, 1, 1}, {9,-1, 1, 1,-1, 0, 1,-1,-1}, {7, 1,-1, 0,-2,-1,-1}, {7,-1, 1, 0, 1, 1, 2}, {7,1,-1, 2, 0, 2, 1}},
  {{11, 0, 0, 0, 1,-1, 0, 0,-1, 1,-1}, {9, 1, 0,-1, 1, 1, 1,-1,-1}, {7, 1,-2, 0,-2,-1,-1}, {7,-1, 1, 0, 2, 1, 0}, {7,1, 1, 1, 0, 2,-1}}
 },
 { // I
  {{11, 0, 0,-1, 0,-2, 0, 1, 0, 2, 0}, {33,-2,-1,-2, 1,-1,-2,-1,-1,-1, 1,-1, 2, 0,-2, 0,-1, 0, 1, 0, 2, 1,-2, 1,-1, 1, 1, 1, 2, 2,-1, 2, 1}, {11,-2,-1,-1,-1, 0,-1, 1,-1, 2, -1}, {11,-2, 1,-1, 1, 0, 1, 1, 1, 2, 1}, {3, 3, 0}},
  {{11, 0, 0, 0, 1, 0, 2, 0,-1, 0,-2}, {33,-2,-1,-2, 0,-2, 1,-1,-2,-1,-1,-1, 0,-1, 1,-1, 2, 1,-2, 1,-1, 1, 0, 1, 1, 1, 2, 2,-1, 2, 0, 2, 1}, {3, 0,-3}, {3, 0, 3}, {11, 1,-2, 1,-1, 1, 0, 1, 1, 1, 2}},
  {{11, 0, 0,-1, 0,-2, 0, 1, 0, 2, 0}, {33,-2,-1,-2, 1,-1,-2,-1,-1,-1, 1,-1, 2, 0,-2, 0,-1, 0, 1, 0, 2, 1,-2, 1,-1, 1, 1, 1, 2, 2,-1, 2, 1}, {11, -2,-1,-1,-1, 0,-1, 1,-1, 2, -1}, {11,-2, 1,-1, 1, 0, 1, 1, 1, 2, 1}, {3, 3, 0}},
  {{11, 0, 0, 0, 1, 0, 2, 0,-1, 0,-2}, {33,-2,-1,-2, 0,-2, 1,-1,-2,-1,-1,-1, 0,-1, 1,-1, 2, 1,-2, 1,-1, 1, 0, 1, 1, 1, 2, 2,-1, 2, 0, 2, 1}, {3, 0,-3}, {3, 0, 3}, {11, 1,-2, 1,-1, 1, 0, 1, 1, 1, 2}}
 },
 { // L
  {{11, 0, 0,-1, 0,-2, 0, 1, 0, 1, 1}, {15,-2, 1,-1, 1,-1, 2, 0,-1, 0, 1, 0, 2, 1,-1}, {9,-2,-1,-1,-1, 0,-1, 1,-1}, {9,-2, 1,-1, 1, 0, 1, 1, 2}, {5, 2, 0, 2, 1}},
  {{11, 0, 0, 0, 1, 0, 2, 0,-1, 1,-1}, {15,-1,-1,-1, 0, 1, 0, 1, 1, 1, 2, 2, 0, 2, 1}, {5, 0,-2, 1,-2}, {5, 0, 3, 1, 0}, {9, 2,-1, 1, 0, 1, 1, 1, 2}},
  {{11, 0, 0, 1, 0, 2, 0,-1, 0,-1,-1}, {15,-1, 1, 0,-1, 0,-2, 0, 1, 1,-2, 1,-1, 2,-1}, {9,-1,-2, 0,-1, 1,-1, 2,-1}, {9,-1, 1, 0, 1, 1, 1, 2, 1}, {5, 0,-1, 3, 0}},
  {{11, 0, 0, 0, 1,-1, 1, 0,-1, 0,-2}, {15,-1,-2,-1,-1,-1, 0, 1, 0, 1, 1,-2,-1,-2, 0}, {5,-1, 0, 0,-3}, {5,-1, 2, 0, 2}, {9, 1,-2, 1,-1, 1, 0, 1, 1}}
 },
 { // L_R
  {{11, 0, 0,-1, 0,-2, 0, 1, 0, 1,-1}, {15,-2, 1,-1, 1,-1, 2, 0,-1, 0, 1, 0, 2,-1,-1}, {9,-2,-1,-1,-1, 0,-1, 1,-2}, {9,-2, 1,-1, 1, 0, 1, 1, 1}, {5, 2, 0, 2,-1}},
  {{11, 0, 0, 0, 1, 0, 2, 0,-1,-1,-1}, {15,-1, 1,-1, 0, 2, 0, 1, 0, 1, 1, 1, 2, 2, 1}, {5, 0,-2,-1,-2}, {5, 0, 3,-1, 0}, {9, 1,-1, 1, 0, 1, 1, 1, 2}},
  {{11, 0, 0, 1, 0, 2, 0,-1, 0,-1, 1}, {15, 1, 1, 0,-1, 0,-2, 0, 1, 1,-2, 1,-1, 2,-1}, {9,-1,-1, 0,-1, 1,-1, 2,-1}, {9,-1, 2, 0, 1, 1, 1, 2, 1}, {5, 0, 1, 3, 0}},
  {{11, 0, 0, 0, 1, 1, 1, 0,-1, 0,-2}, {15,-1,-2,-1,-1,-1, 0, 1, 0, 1,-1,-2,-1,-2, 0}, {5, 1, 0, 0,-3}, {5, 1, 2, 0, 2}, {9, 1,-2, 1,-1, 1, 0, 2, 1}}
 },
 { // N
  {{11, 0, 0,-1, 1, 0, 1, 1, 0, 2, 0}, {17,-1, 2, 0, 2, 0,-2, 0,-1, 1,-2, 1,-1, 1, 1, 2,-1}, {9,-1, 0, 0,-1, 1,-1, 2,-1}, {9,-1, 2, 0, 2, 1, 1, 2, 1}, {5, 3, 0, 1, 1}},
  {{11, 0, 0, 0,-2, 0,-1, 1, 0, 1, 1}, {17,-2,-1,-2, 0,-1,-2,-1,-1,-1, 0, 1,-1, 2, 0, 2, 1}, {5, 0,-3, 1,-1}, {5, 0, 1, 1, 2}, {9, 1,-2, 1,-1, 2, 0, 2, 1}},
  {{11, 0, 0,-2, 0,-1, 0, 0,-1, 1,-1}, {17,-2, 1,-1,-1,-1, 1,-1, 2, 0,-2, 0, 1, 0, 2, 1,-2}, {9,-2,-1,-1,-1, 0,-2, 1,-2}, {9,-2, 1,-1, 1, 0, 1, 1, 0}, {5, 2,-1, 1, 0}},
  {{11, 0, 0,-1,-1,-1, 0, 0, 1, 0, 2}, {17,-2,-1,-2, 0,-1, 1, 1, 0, 1, 1, 1, 2, 2, 0, 2, 1}, {5,-1,-2, 0,-1}, {5,-1, 1, 0, 3}, {9, 0,-1, 1, 0, 1, 1, 1, 2}}
 },
 { // N_R
  {{11, 0, 0,-1,-1, 0,-1, 1, 0, 2, 0}, {13,-1, 0,-1, 1, 0,-2, 1,-2, 1,-1, 2,-1}, {9,-1,-2, 0,-2, 1,-1, 2,-1}, {9,-1, 0, 0, 1, 1, 1, 2, 1}, {5, 3, 0, 1,-1}},
  {{11, 0, 0, 0,-2, 0,-1,-1, 0,-1, 1}, {13,-1,-2,-1,-1,-2,-1,-2, 0, 0, 1, 1, 1}, {5, 0,-3,-1,-1}, {5, 0, 1,-1, 2}, {9, 1,-2, 1,-1, 1, 0, 0, 1}},
  {{11, 0, 0,-2, 0,-1, 0, 0, 1, 1, 1}, {13,-2, 1,-1, 1,-1, 2, 0, 2, 1,-1, 1, 0}, {9,-2,-1,-1,-1, 0,-1, 1, 0}, {9, -2, 1,-1, 1, 0, 2, 1, 2}, {5, 2, 1, 1, 0}},
  {{11, 0, 0, 1,-1, 1, 0, 0, 1, 0, 2}, {13,-1,-1, 0,-1, 1, 1, 1, 2, 2, 0, 2, 1}, {5, 1,-2, 0,-1}, {5, 1, 1, 0, 3}, {9, 1, 1, 1, 2, 2,-1, 2, 0}}
 },
 { // P
  {{11, 0, 0, 0, 1, 1, 0, 1, 1,-1, 1}, {7,-1, 2, 0, 2, 1, 2}, {7,-1, 0, 0,-1, 1,-1}, {7,-1, 2, 0, 2, 1, 2}, {5, 2, 0, 2, 1}},
  {{11, 0, 0, 0, 1, 1, 0, 1, 1, 1, 2}, {7, 2, 0, 2, 1, 2, 2}, {5, 0,-1, 1,-1}, {5,0, 2, 1, 3}, {7, 2, 0, 2, 1, 2, 2}},
  {{11, 0, 0, 0, 1, 1, 0, 1, 1, 2, 0}, {7, 0,-1, 1,-1, 2,-1}, {7, 0,-1, 1,-1, 2,-1}, {7, 0, 2, 1, 2, 2, 1}, {5, 3, 0, 2, 1}},
  {{11, 0, 0, 0, 1, 1, 0, 1, 1, 0,-1}, {7,-1,-1,-1, 0,-1, 1}, {5, 0,-2, 1,-1}, {5, 0, 2, 1, 2}, {7, 1,-1, 2, 0, 2, 1}}
 },
 { // P_R
  {{11, 0, 0, 0, 1, 1, 0, 1, 1,-1, 0}, {7,-1, 2,-1, 1, 0, 2}, {7,-1,-1, 0,-1, 1,-1}, {7,-1, 1, 0, 2, 1, 2}, {5, 2, 0, 2, 1}},
  {{11, 0, 0, 0, 1, 1, 0, 1, 1, 0, 2}, {7, 2, 2, 2, 1, 1, 2}, {5, 0,-1, 1,-1}, {5, 0, 3, 1, 2}, {7, 2, 0, 2, 1, 1, 2}},
  {{11, 0, 0, 0, 1, 1, 0, 1, 1, 2, 1}, {7, 2, 0, 1,-1, 2,-1}, {7, 0,-1, 1,-1, 2, 0}, {7, 0, 2, 1, 2, 2, 2}, {5, 2, 0, 3, 1}},
  {{11, 0, 0, 0, 1, 1, 0, 1, 1, 1,-1}, {7,-1,-1,-1, 0, 0,-1}, {5, 0,-1, 1,-2}, {5, 0, 2, 1, 2}, {7, 2,-1, 2, 0, 2, 1}}
 },
 { // T
  {{11, 0, 0,-1,-1,-1, 0,-1, 1, 1, 0}, {9, 0,-1, 0, 1, 1,-1, 1, 1}, {7,-1,-2, 0,-1, 1,-1}, {7,-1, 2, 0, 1, 1, 1}, {7, 0,-1, 2, 0, 0, 1}},
  {{11, 0, 0, 0,-1,-1, 1, 0, 1, 1, 1}, {9,-1,-1,-1, 0, 1,-1, 1, 0}, {7,-1, 0, 0,-2, 1, 0}, {7,-1, 2, 0, 2, 1, 2}, {7, 1,-1, 1, 0, 2, 1}},
  {{11, 0, 0,-1, 0, 1,-1, 1, 0, 1, 1}, {9,-1,-1,-1, 1, 0,-1, 0, 1}, {7,-1,-1, 0,-1, 1,-2}, {7,-1, 1, 0, 1, 1, 2}, {7, 2,-1, 2, 0, 2, 1}},
  {{11, 0, 0, 0,-1, 0, 1,-1,-1, 1,-1}, {9,-1, 0,-1, 1, 1, 0, 1, 1}, {7,-1,-2, 0,-2, 1,-2}, {7,-1, 0, 0, 2, 1, 0}, {7, 2,-1, 1, 0, 1, 1}}
 },
 { // U
  {{11, 0, 0, 0,-1, 0, 1,-1,-1,-1, 1}, {7, 1, 0, 1, 1,-1, 0}, {7,-1,-2, 0,-2,-1, 0}, {7,-1, 2, 0, 2,-1, 0}, {7, 1,-1, 1, 0, 1, 1}},
  {{11, 0, 0,-1, 0,-1, 1, 1, 0, 1, 1}, {7, 0,-1, 1,-1, 0, 1}, {7,-1,-1, 0,-1, 1,-1}, {7,-1, 2, 0, 1, 1, 2}, {7, 2, 0, 2, 1, 0, 1}},
  {{11, 0, 0, 0,-1, 1,-1, 0, 1, 1, 1}, {7,-1,-1,-1, 0, 1, 0}, {7, 0,-2, 1,-2, 1, 0}, {7, 0, 2, 1, 2, 1, 0}, {7, 2,-1, 1, 0, 2, 1}},
  {{11, 0, 0,-1,-1,-1, 0, 1,-1, 1, 0}, {7,-1, 1, 0, 1, 0,-1}, {7,-1,-2, 0,-1, 1,-2}, {7,-1, 1, 0, 1, 1, 1}, {7, 2,-1, 2, 0, 0,-1}}
 },
 { // W
  {{11, 0, 0, 0,-1,-1,-1, 1, 0, 1, 1}, {11,-1, 0,-1, 1, 1,-1, 2, 0, 2, 1}, {7,-1,-2, 0,-2, 1,-1}, {7,-1, 0, 0, 1, 1, 2}, {7, 1,-1, 2, 0, 2, 1}},
  {{11, 0, 0, 0,-1, 1,-1,-1, 0,-1, 1}, {11,-1,-1, 0,-2, 0, 1, 1,-2, 1, 1}, {7,-1,-1, 0,-2, 1,-2}, {7,-1, 2, 0, 1, 1, 0}, {7, 2,-1, 1, 0, 0, 1}},
  {{11, 0, 0,-1,-1,-1, 0, 0, 1, 1, 1}, {11,-2,-1,-2, 0,-1, 1, 1,-1, 1, 0}, {7,-1,-2, 0,-1, 1, 0}, {7,-1, 1, 0, 2, 1, 2}, {7, 0,-1, 1, 0, 2, 1}},
  {{11, 0, 0, 0, 1,-1, 1, 1,-1, 1, 0}, {11,-1,-1, 0,-1,-1, 2, 0, 2, 1, 1}, {7,-2, 0, 0,-1, 1,-2}, {7,-1, 2, 0, 2, 1, 1}, {7, 2,-1, 2, 0, 1, 1}}
 },
 { // Y
  {{11, 0, 0, 0,-1,-1, 0, 1, 0, 2, 0}, {15,-1,-1,-1, 1, 0,-2, 0, 1, 1,-2, 1,-1, 2,-1}, {9,-1,-1, 0,-2, 1,-1, 2,-1}, {9,-1, 1, 0, 1, 1, 1, 2, 1}, {5, 1,-1, 3, 0}},
  {{11, 0, 0,-1, 0, 0,-2, 0,-1, 0, 1}, {15,-1,-2,-1,-1,-2,-1,-2, 0,-1, 1, 1, 0, 1, 1}, {5,-1,-1, 0,-3}, {5,-1, 1, 0, 2}, {9, 1,-2, 1,-1, 1, 0, 1, 1}},
  {{11, 0, 0,-1, 0,-2, 0, 1, 0, 0, 1}, {15, 0,-1, 1,-1,-2, 1,-1, 1,-1, 2, 0, 2, 1, 1}, {9,-2,-1,-1,-1, 0,-1, 1,-1}, {9,-2, 1,-1, 1, 0, 2, 1, 1}, {5, 2, 0, 1, 1}},
  {{11, 0, 0, 0,-1, 0, 1, 0, 2, 1, 0}, {15,-1,-1,-1, 0, 1,-1, 1, 1, 1, 2, 2, 0, 2, 1}, {5, 0,-2, 1,-1}, {5, 0, 3, 1, 1}, {9, 1,-1, 2, 0, 1, 1, 1, 2}}
 },
 { // Y_R
  {{11, 0, 0, 0, 1,-1, 0, 1, 0, 2, 0}, {15,-1, 1, 1, 1, 0,-2, 0,-1, 1,-2, 1,-1, 2,-1}, {9,-1,-1, 0,-1, 1,-1, 2,-1}, {9,-1, 1, 0, 2, 1, 1, 2, 1}, {5, 1, 1, 3, 0}},
  {{11, 0, 0, 1, 0, 0,-2, 0,-1, 0, 1}, {15,-1,-2,-1,-1,-2,-1,-2, 0,-1, 0, 1,-1, 1, 1}, {5, 1,-1, 0,-3}, {5, 1, 1, 0, 2}, {9, 1,-2, 1,-1, 2, 0, 1, 1}},
  {{11, 0, 0,-1, 0,-2, 0, 1, 0, 0,-1}, {15, 0, 1, 1,-1,-2, 1,-1, 1,-1, 2, 0, 2,-1,-1}, {9,-2,-1,-1,-1, 0,-2, 1,-1}, {9,-2, 1,-1, 1, 0, 1, 1, 1}, {5, 2, 0, 1,-1}},
  {{11, 0, 0, 0,-1, 0, 1, 0, 2,-1, 0}, {15,-1,-1,-1, 1, 1, 0, 1, 1, 1, 2, 2, 0, 2, 1}, {5, 0,-2,-1,-1}, {5, 0, 3,-1, 1}, {9, 1,-1, 1, 0, 1, 1, 1, 2}}
 },
 { // I_SHORT
  {{7, 0, 0,-1, 0, 1, 0}, {13,-1,-1,-1, 1, 0,-1, 0, 1, 1,-1, 1, 1}, {7,-1,-1, 0,-1, 1,-1}, {7,-1, 1, 0, 1, 1, 1}, {3, 2, 0}},
  {{7, 0, 0, 0, 1, 0,-1}, {13,-1,-1,-1, 0,-1, 1, 1,-1, 1, 0, 1, 1}, {3, 0,-2}, {3, 0, 2}, {7, 1,-1, 1, 0, 1, 1}},
  {{7, 0, 0,-1, 0, 1, 0}, {13,-1,-1,-1, 1, 0,-1, 0, 1, 1,-1, 1, 1}, {7, -1,-1, 0,-1, 1,-1}, {7, -1, 1, 0, 1, 1, 1}, {3, 2, 0}},
  {{7, 0, 0, 0, 1, 0,-1}, {13,-1,-1,-1, 0,-1, 1, 1,-1, 1, 0, 1, 1}, {3, 0,-2}, {3, 0, 2}, {7, 1,-1, 1, 0, 1, 1}}
 }
};

Block *create_block() {
    Block *block = malloc(sizeof(Block));
    return block;
}

void delete_block(Block *b) {
    free(b);
}

void init_block(Block *b, int type, int rot, int row, int col) {
    b->type = type;
    b->rot = rot;
    b->row = row;
    b->col = col;
    b->mark = type;
}

void init_ghost_block(Block *b, int type, int rot, int row, int col) {
    b->type = type;
    b->rot = rot;
    b->row = row;
    b->col = col;
    b->mark = GHOST;
}

void erase_block(Block *b, Field *f) {
    // for each block cell write BG in the corresponding field cell
    int i;
    for (i = 1; i < COORD[0]; i += 2) {
        if (COORD[i] + b->row >= 0 && COORD[i + 1] + b->col >= 0) {
            f->grid[COORD[i] + b->row][COORD[i + 1] + b->col] = BG;
        }
    }
}

void write_block(Block *b, Field *f) {
    // write mark of each block cell in the corresponding field cell
    int i;
    for (i = 1; i < COORD[0]; i += 2) {
        if (COORD[i] + b->row >= 0 && COORD[i + 1] + b->col >= 0) {
            f->grid[COORD[i] + b->row][COORD[i + 1] + b->col] = b->mark;
        }
    }
}

void update_block(Block *b, Field *f, int new_rot, int new_row, int new_col) {
    erase_block(b, f);
    b->rot = new_rot;
    b->row = new_row;
    b->col = new_col;
    write_block(b, f);
}

int get_limit_high_block(Block *b) {
    // find max row index
    int i;
    int limit_high = COORD[1] + b->row;
    for (i = 3; i < COORD[0]; i += 2) {
        if (COORD[i] + b->row > limit_high) {
            limit_high = COORD[i] + b->row;
        }
    }
    return limit_high;
}

int get_limit_low_block(Block *b) {
    // find min row index
    int i;
    int limit_low = COORD[1] + b->row;
    for (i = 3; i < COORD[0]; i += 2) {
        if (COORD[i] + b->row < limit_low) {
           limit_low = COORD[i] + b->row;
        }
    }
    return limit_low;
}

void move_block(Block *b, Field *f, int dir) {
    switch (dir) {
        case LEFT:
            update_block(b, f, b->rot, b->row, b->col - 1);
            break;
        case RIGHT:
            update_block(b, f, b->rot, b->row, b->col + 1);
            break;
        case DOWN:
            update_block(b, f, b->rot, b->row + 1, b->col);
            break;	
    }
}

void rotate_block(Block *b, Field *f) {
    update_block(b, f, (b->rot + 1) % 4, b->row, b->col);
}

bool can_move_block(Block *b, Field *f, int dir) {
    int i;
    for (i = 1; i < DIR_CHECK[0]; i += 2) {
        // check field bounds
        if (DIR_CHECK[i + 1] + b->col < 0 || DIR_CHECK[i + 1] + b->col >= COLUMNS) {
            return false;
        }
        // check if the target cells are free (BG or GHOST)
        if (DIR_CHECK[i] + b->row >= 0) {
            if (DIR_CHECK[i] + b->row >= ROWS || (f->grid[DIR_CHECK[i] + b->row][DIR_CHECK[i + 1] + b->col] != BG && f->grid[DIR_CHECK[i] + b->row][DIR_CHECK[i + 1] + b->col] != GHOST)) {
                return false;
            }
        }
    }
    return true;
}

bool can_rotate_block(Block *b, Field *f) {
    int i;
    for (i = 1; i < ROT_CHECK[0]; i += 2) {
        // check block bounds
        if (ROT_CHECK[i + 1] + b->col < 0 || ROT_CHECK[i + 1] + b->col >= COLUMNS) {
            return false;
        }
        // check if the target cells are free (BG or GHOST)
        if (ROT_CHECK[i] + b->row >= 0) {
            if (ROT_CHECK[i] + b->row >= ROWS || (f->grid[ROT_CHECK[i] + b->row][ROT_CHECK[i + 1] + b->col] != BG && f->grid[ROT_CHECK[i] + b->row][ROT_CHECK[i + 1] + b->col] != GHOST)) {
                return false;
            }
        }
    }
    return true;
}
/** \} */
